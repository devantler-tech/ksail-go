apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cni-bootstrap
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: cni-bootstrap
  template:
    metadata:
      labels:
        app: cni-bootstrap
    spec:
      hostNetwork: true
      priorityClassName: system-node-critical
      tolerations:
      - operator: Exists
      containers:
      - name: install-cni-plugins
        image: alpine:3.20
        securityContext:
          privileged: true
        command: ["/bin/sh","-c"]
        args:
        - |
          set -e
          apk add --no-cache curl tar > /dev/null 2>&1
          cd /opt/cni/bin
          if [ -f bridge ]; then echo "[cni-bootstrap] bridge plugin already present"; sleep 2; exit 0; fi
          echo "[cni-bootstrap] downloading CNI plugins..."
          curl -L https://github.com/containernetworking/plugins/releases/download/v1.5.1/cni-plugins-linux-amd64-v1.5.1.tgz | tar -xz
          echo "[cni-bootstrap] installed plugins:"; ls -1
          sleep 2
        volumeMounts:
        - name: cni-bin
          mountPath: /opt/cni/bin
      restartPolicy: Always
      volumes:
      - name: cni-bin
        hostPath:
          path: /opt/cni/bin
