package fluxgenerator_test

import (
	"strings"
	"testing"
	"time"

	fluxgenerator "github.com/devantler-tech/ksail-go/pkg/io/generator/flux"
	"github.com/fluxcd/flux2/v2/pkg/manifestgen/install"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

const (
	testFluxVersion   = "v2.7.3"
	testFluxNamespace = "flux-system"
)

func TestNewInstallGenerator(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewInstallGenerator()

	assert.NotNil(t, gen)
}

func TestInstallGeneratorGenerate(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewInstallGenerator()

	// Create minimal install options
	installOpts := install.MakeDefaultOptions()
	installOpts.Version = testFluxVersion
	installOpts.Namespace = testFluxNamespace
	installOpts.Components = []string{"source-controller", "kustomize-controller"}
	installOpts.Timeout = 1 * time.Minute

	opts := fluxgenerator.InstallOptions{
		Options: installOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.NotEmpty(t, result)

	// Verify the generated manifest contains expected content
	assert.Contains(t, result, "apiVersion:")
	assert.Contains(t, result, "kind:")
	assert.Contains(t, result, testFluxNamespace)
	assert.Contains(t, result, "# This manifest was generated by flux. DO NOT EDIT.")
}

func TestInstallGeneratorGenerateWithOutput(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewInstallGenerator()
	tempDir := t.TempDir()

	installOpts := install.MakeDefaultOptions()
	installOpts.Version = testFluxVersion
	installOpts.Namespace = testFluxNamespace
	installOpts.Components = []string{"source-controller", "kustomize-controller"}
	installOpts.Timeout = 1 * time.Minute

	outputPath := tempDir + "/flux-install.yaml"

	opts := fluxgenerator.InstallOptions{
		Options: installOpts,
		Output:  outputPath,
		Force:   false,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.NotEmpty(t, result)
	assert.Contains(t, result, testFluxNamespace)
}

func TestInstallGeneratorGenerateWithInvalidOutputDirectory(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewInstallGenerator()

	installOpts := install.MakeDefaultOptions()
	installOpts.Version = testFluxVersion
	installOpts.Namespace = testFluxNamespace
	installOpts.Components = []string{"source-controller", "kustomize-controller"}
	installOpts.Timeout = 1 * time.Minute

	// Use invalid path that should cause write error
	invalidPath := "/invalid/path/that/does/not/exist/flux-install.yaml"

	opts := fluxgenerator.InstallOptions{
		Options: installOpts,
		Output:  invalidPath,
		Force:   false,
	}

	_, err := gen.Generate(nil, opts)

	require.Error(t, err)
	assert.Contains(t, err.Error(), "failed to write manifest to file")
}

func TestInstallGeneratorGenerateStructure(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewInstallGenerator()

	installOpts := install.MakeDefaultOptions()
	installOpts.Version = testFluxVersion
	installOpts.Namespace = "test-namespace"
	installOpts.Components = []string{"source-controller", "kustomize-controller"}
	installOpts.Timeout = 1 * time.Minute

	opts := fluxgenerator.InstallOptions{
		Options: installOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)

	// Verify the structure
	assert.Contains(t, result, "# This manifest was generated by flux")
	assert.Contains(t, result, "apiVersion:")
	assert.Contains(t, result, "kind:")
	assert.Contains(t, result, "test-namespace")
	assert.NotEmpty(t, result)

	// Verify it has multiple lines (a comprehensive manifest)
	lines := strings.Split(result, "\n")
	assert.Greater(t, len(lines), 10, "Expected a substantial manifest with many lines")
}
