package fluxgenerator_test

import (
	"strings"
	"testing"
	"time"

	fluxgenerator "github.com/devantler-tech/ksail-go/pkg/io/generator/flux"
	"github.com/fluxcd/flux2/v2/pkg/manifestgen/sync"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestNewSyncGenerator(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	assert.NotNil(t, gen)
}

func TestSyncGeneratorGenerate(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	syncOpts := sync.Options{
		Name:       "test-repo",
		Namespace:  "flux-system",
		URL:        "https://github.com/example/repo",
		Branch:     "main",
		Interval:   5 * time.Minute,
		TargetPath: "./clusters/test",
		Secret:     "git-credentials",
	}

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.NotEmpty(t, result)

	// Verify the generated manifest contains expected content
	assert.Contains(t, result, "apiVersion:")
	assert.Contains(t, result, "kind:")
	assert.Contains(t, result, "GitRepository")
	assert.Contains(t, result, "Kustomization")
	assert.Contains(t, result, "test-repo")
	assert.Contains(t, result, "flux-system")
	assert.Contains(t, result, "# This manifest was generated by flux. DO NOT EDIT.")
}

func TestSyncGeneratorGenerateWithOutput(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()
	tempDir := t.TempDir()

	syncOpts := sync.Options{
		Name:         "test-repo",
		Namespace:    "flux-system",
		URL:          "https://github.com/example/repo",
		Branch:       "main",
		Interval:     5 * time.Minute,
		TargetPath:   "./clusters/test",
		Secret:       "git-credentials",
		ManifestFile: "sync.yaml",
	}

	outputPath := tempDir + "/flux-sync.yaml"

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
		Output:  outputPath,
		Force:   false,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.NotEmpty(t, result)
	assert.Contains(t, result, "test-repo")
}

func TestSyncGeneratorGenerateWithInvalidOutputDirectory(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	syncOpts := sync.Options{
		Name:       "test-repo",
		Namespace:  "flux-system",
		URL:        "https://github.com/example/repo",
		Branch:     "main",
		Interval:   5 * time.Minute,
		TargetPath: "./clusters/test",
		Secret:     "git-credentials",
	}

	// Use invalid path that should cause write error
	invalidPath := "/invalid/path/that/does/not/exist/flux-sync.yaml"

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
		Output:  invalidPath,
		Force:   false,
	}

	_, err := gen.Generate(nil, opts)

	require.Error(t, err)
	assert.Contains(t, err.Error(), "failed to write manifest to file")
}

func TestSyncGeneratorGenerateWithTag(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	syncOpts := sync.Options{
		Name:       "test-repo",
		Namespace:  "flux-system",
		URL:        "https://github.com/example/repo",
		Tag:        "v1.0.0",
		Interval:   5 * time.Minute,
		TargetPath: "./clusters/test",
		Secret:     "git-credentials",
	}

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.Contains(t, result, "v1.0.0")
	assert.Contains(t, result, "tag:")
}

func TestSyncGeneratorGenerateWithCommit(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	syncOpts := sync.Options{
		Name:       "test-repo",
		Namespace:  "flux-system",
		URL:        "https://github.com/example/repo",
		Commit:     "abc123def456",
		Interval:   5 * time.Minute,
		TargetPath: "./clusters/test",
		Secret:     "git-credentials",
	}

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)
	assert.Contains(t, result, "abc123def456")
	assert.Contains(t, result, "commit:")
}

func TestSyncGeneratorGenerateStructure(t *testing.T) {
	t.Parallel()

	gen := fluxgenerator.NewSyncGenerator()

	syncOpts := sync.Options{
		Name:       "test-repo",
		Namespace:  "flux-system",
		URL:        "https://github.com/example/repo",
		Branch:     "main",
		Interval:   5 * time.Minute,
		TargetPath: "./clusters/test",
		Secret:     "git-credentials",
	}

	opts := fluxgenerator.SyncOptions{
		Options: syncOpts,
	}

	result, err := gen.Generate(nil, opts)

	require.NoError(t, err)

	// Verify the manifest has proper structure with two resources
	sections := strings.Split(result, "---")

	// Should have: warning comment + GitRepository + Kustomization
	// The warning is not separated by ---, so we expect at least 2 sections after first ---
	assert.GreaterOrEqual(t, len(sections), 2, "expected at least 2 YAML documents")

	// Verify both resource types are present
	assert.Contains(t, result, "kind: GitRepository")
	assert.Contains(t, result, "kind: Kustomization")

	// Verify required fields
	assert.Contains(t, result, "metadata:")
	assert.Contains(t, result, "spec:")
	assert.Contains(t, result, "sourceRef:")
}
