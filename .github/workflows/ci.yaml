name: CI - Go (Repo)

on:
  push:
    branches: [main]
  pull_request:

permissions: {}

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“„ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ”§ Install mockery
        run: go install github.com/vektra/mockery/v3@latest

      - name: ðŸƒ Run pre-commit hooks
        uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1

  ci:
    needs: [pre-commit]
    if: github.event_name == 'push'
    uses: devantler-tech/reusable-workflows/.github/workflows/ci-go.yaml@800bac1f7de14fcc6b9b9bcf62e201308eafd15b # v1.15.12
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    permissions:
      contents: write
      issues: write
      packages: read
      pull-requests: write

  system-test:
    runs-on: ubuntu-latest
    # Run system tests on both push and pull request, but only after pre-commit and ci jobs complete
    needs: [pre-commit, ci]
    if: always() && (needs.ci.result == 'success' || needs.ci.result == 'skipped')
    strategy:
      matrix:
        include:
          - init-args: "--distribution Kind"
          - init-args: "--distribution Kind --cni Cilium"
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io"
            test-workload: true
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
            test-workload: true
          - init-args: "--distribution K3d"
          - init-args: "--distribution K3d --cni Cilium"
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io"
            test-workload: true
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
            test-workload: true
          - init-args: "--distribution K3d --metrics-server Disabled"
    steps:
      - name: ðŸ“„ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ—ï¸ Build application
        run: go build -o ksail .

      - name: ðŸ§ª ksail cluster init
        run: |
          ./ksail cluster init ${{ matrix.init-args }}

      - name: ðŸ§ª ksail cluster create
        run: |
          ./ksail cluster create

      - name: ðŸ§ª ksail cluster list
        run: |
          ./ksail cluster list

      - name: ðŸ§ª ksail workload create
        if: matrix.test-workload
        run: |
          ./ksail workload create deployment whoami --image=traefik/whoami:latest
          ./ksail workload wait --for=condition=Available deployment/whoami --timeout=120s

      - name: ðŸ” Diagnose ghcr.io connectivity
        if: matrix.test-workload
        run: |
          echo "::group::1. Test ghcr.io connectivity from runner"
          echo "Testing DNS resolution:"
          nslookup ghcr.io || echo "DNS resolution failed"
          echo ""
          echo "Testing HTTPS connectivity:"
          curl -v https://ghcr.io/v2/ 2>&1 | head -30 || echo "ghcr.io not accessible from runner"
          echo "::endgroup::"
          
          echo "::group::2. Verify podinfo image exists"
          echo "Fetching anonymous token:"
          TOKEN=$(curl -s "https://ghcr.io/token?scope=repository:stefanprodan/podinfo:pull" | jq -r .token)
          echo "Token obtained: ${TOKEN:0:20}..."
          echo ""
          echo "Fetching image manifest:"
          curl -s -H "Authorization: Bearer $TOKEN" https://ghcr.io/v2/stefanprodan/podinfo/manifests/6.9.2 | head -30 || echo "Could not fetch manifest"
          echo "::endgroup::"
          
          echo "::group::3. Test DNS resolution from within cluster"
          kubectl run dns-test --image=busybox:latest --restart=Never --command -- sleep 30
          sleep 5
          kubectl exec dns-test -- nslookup ghcr.io || echo "DNS resolution failed from pod"
          kubectl exec dns-test -- nslookup registry-1.docker.io || echo "Docker Hub DNS failed from pod"
          kubectl delete pod dns-test --force --grace-period=0
          echo "::endgroup::"
          
          echo "::group::4. Test network connectivity from within cluster"
          kubectl run net-test --image=nicolaka/netshoot:latest --restart=Never --command -- sleep 60
          sleep 5
          echo "Testing connectivity to ghcr.io:"
          kubectl exec net-test -- curl -v https://ghcr.io/v2/ 2>&1 | head -40 || echo "Network test failed"
          echo ""
          echo "Testing connectivity to docker.io:"
          kubectl exec net-test -- curl -v https://registry-1.docker.io/v2/ 2>&1 | head -40 || echo "Docker Hub test failed"
          kubectl delete pod net-test --force --grace-period=0
          echo "::endgroup::"
          
          echo "::group::5. Check containerd/cri-o configuration"
          for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
            echo "=== Inspecting Node: $node ==="
            echo "Checking for containerd config:"
            kubectl debug node/$node --image=busybox:latest -- cat /etc/containerd/config.toml 2>/dev/null || echo "containerd config not found"
            echo ""
            echo "Checking for crio config:"
            kubectl debug node/$node --image=busybox:latest -- ls -la /etc/containers/ 2>/dev/null || echo "crio config not found"
            echo ""
            echo "Checking hosts.toml for registry configs:"
            kubectl debug node/$node --image=busybox:latest -- find /etc/containerd -name "hosts.toml" -exec cat {} \; 2>/dev/null || echo "No hosts.toml found"
          done
          echo "::endgroup::"
          
          echo "::group::6. Attempt direct image pull test"
          kubectl run ghcr-test --image=ghcr.io/stefanprodan/podinfo:6.9.2 --restart=Never --command -- sleep 3600
          echo "Waiting for pod to start or fail..."
          sleep 15
          echo ""
          echo "Pod status:"
          kubectl get pod ghcr-test -o wide || echo "Pod not found"
          echo ""
          echo "Pod events:"
          kubectl get events --field-selector involvedObject.name=ghcr-test --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "Pod describe:"
          kubectl describe pod ghcr-test | tail -50
          kubectl delete pod ghcr-test --force --grace-period=0 2>/dev/null
          echo "::endgroup::"

      - name: ðŸ§ª ksail workload apply
        if: matrix.test-workload
        run: |
          # Create temporary kustomization that excludes HPA from podinfo
          mkdir -p /tmp/podinfo-overlay
          cat > /tmp/podinfo-overlay/kustomization.yaml <<'EOF'
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - https://github.com/stefanprodan/podinfo//kustomize
          patches:
            - target:
                kind: HorizontalPodAutoscaler
              patch: |-
                $patch: delete
                apiVersion: autoscaling/v2
                kind: HorizontalPodAutoscaler
                metadata:
                  name: podinfo
          EOF
          # Apply podinfo without HPA using ksail
          ./ksail workload apply -k /tmp/podinfo-overlay
          # Wait for deployment to become available, with debugging on failure
          if ! ./ksail workload wait --for=condition=Available deployment/podinfo --timeout=300s; then
            echo "::group::Deployment status"
            kubectl get deployment podinfo -o yaml
            echo "::endgroup::"
            echo "::group::Pod status"
            kubectl get pods -l app=podinfo -o wide
            echo "::endgroup::"
            echo "::group::Pod events"
            kubectl get events --field-selector involvedObject.name=$(kubectl get pods -l app=podinfo -o jsonpath='{.items[0].metadata.name}') --sort-by='.lastTimestamp'
            echo "::endgroup::"
            echo "::group::Pod logs"
            kubectl logs -l app=podinfo --all-containers=true --tail=100 || echo "No logs available"
            echo "::endgroup::"
            echo "::group::Pod describe"
            kubectl describe pods -l app=podinfo
            echo "::endgroup::"
            exit 1
          fi

      - name: ðŸ§ª ksail workload reconcile
        run: |
          ./ksail workload reconcile

      - name: ðŸ§ª ksail cluster stop
        run: |
          ./ksail cluster stop

      - name: ðŸ§ª ksail cluster start
        run: |
          ./ksail cluster start

      - name: ðŸ§ª ksail cluster delete
        run: |
          ./ksail cluster delete

      - name: ðŸ§¹ Cleanup
        run: |
          if [ -d "k8s" ]; then rm -rf "k8s"; fi
          if [ -f "kind.yaml" ]; then rm "kind.yaml"; fi
          if [ -f "k3d.yaml" ]; then rm "k3d.yaml"; fi
          if [ -f "ksail.yaml" ]; then rm "ksail.yaml"; fi

  system-test-status:
    runs-on: ubuntu-latest
    needs: [system-test]
    if: always()
    steps:
      - name: Summarize matrix result
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "system-test result: $MATRIX_RESULT"
          case "$MATRIX_RESULT" in
            success|skipped)
              echo "All matrix runs succeeded or were skipped."
              exit 0
              ;;
            *)
              echo "At least one matrix run failed."
              exit 1
              ;;
          esac
        env:
          MATRIX_RESULT: ${{ needs.system-test.result }}
