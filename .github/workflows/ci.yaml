name: CI - Go (Repo)

on:
  push:
    branches: [main]
  pull_request:

permissions: {}

jobs:
  generate-schema:
    name: ðŸ“ Generate JSON Schema
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    permissions:
      contents: write
    steps:
      - name: ðŸ”‘ Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ðŸ“„ Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          cache: true

      - name: ðŸ“ Generate JSON schema
        run: .github/scripts/generate-schema.sh

      - name: ðŸ“¤ Commit and push schema changes
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7.0.0
        with:
          commit_message: "chore: update generated JSON schema"
          file_pattern: schemas/ksail-config.schema.json

  golangci-lint:
    name: ðŸ§¹ Lint - golangci-lint
    runs-on: ubuntu-latest
    needs: [generate-schema]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: ðŸ”‘ Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ðŸ“„ Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ github.head_ref }}
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: 1.25.4
          cache: true

      - name: â¬‡ï¸ Download Go modules
        run: go mod download

      - name: ðŸ§¹ Run golangci-lint
        uses: golangci/golangci-lint-action@e7fa5ac41e1cf5b7d48e45e42232ce7ada589601 # v9.1.0
        with:
          version: v2.6.2
          args: --fix

      - name: ðŸ’¾ Commit and push applied linter fixes
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7.0.0
        with:
          branch: >-
            ${{
              github.event.pull_request.head.ref ||
              github.head_ref ||
              github.ref
            }}
          commit_message: "chore: apply golangci-lint fixes"
          commit_user_name: golangci-lint-bot
          commit_user_email: golangci-lint-bot@users.noreply.github.com

  ci:
    needs: [generate-schema]
    uses: devantler-tech/reusable-workflows/.github/workflows/ci-go.yaml@0763de30f9598601916680b2f52c9f41f14082df # v1.21.0
    with:
      working-directory: ./
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
    permissions:
      contents: write
      issues: write
      packages: read
      pull-requests: write

  system-test:
    runs-on: ubuntu-latest
    # Run system tests on both push and pull request, but only after pre-commit and ci jobs complete
    needs: [ci]
    strategy:
      matrix:
        include:
          - init-args: "--distribution Kind"
          - init-args: "--distribution Kind --cni Cilium"
          - init-args: "--distribution Kind --cni Calico"
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io"
            test-workload: true
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
            test-workload: true
          - init-args: "--distribution K3d"
          - init-args: "--distribution K3d --cni Cilium"
          - init-args: "--distribution K3d --cni Calico"
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io"
            test-workload: true
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
            test-workload: true
          - init-args: "--distribution K3d --metrics-server Disabled"
    steps:
      - name: ðŸ“„ Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ—ï¸ Build application
        run: go build -o ksail .

      - name: ðŸ§ª ksail cluster init
        run: |
          ./ksail cluster init ${{ matrix.init-args }}

      - name: ðŸ§ª ksail cluster create
        run: |
          ./ksail cluster create

      - name: ðŸ§ª ksail cluster list
        run: |
          ./ksail cluster list

      - name: ðŸ§ª ksail workload create
        if: matrix.test-workload
        run: |
          ./ksail workload create deployment whoami --image=traefik/whoami:latest
          ./ksail workload wait --for=condition=Available deployment/whoami --timeout=120s

      - name: ðŸ§ª ksail workload apply
        if: matrix.test-workload
        run: |
          mkdir -p /tmp/podinfo-overlay
          cat > /tmp/podinfo-overlay/kustomization.yaml <<'EOF'
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - https://github.com/stefanprodan/podinfo//kustomize
          patches:
            - target:
                kind: HorizontalPodAutoscaler
              patch: |-
                $patch: delete
                apiVersion: autoscaling/v2
                kind: HorizontalPodAutoscaler
                metadata:
                  name: podinfo
          EOF
          ./ksail workload apply -k /tmp/podinfo-overlay
          ./ksail workload wait --for=condition=Available deployment/podinfo --timeout=300s

      - name: ðŸ§ª ksail workload reconcile
        run: |
          ./ksail workload reconcile

      - name: ðŸ§ª ksail cluster stop
        run: |
          ./ksail cluster stop

      - name: ðŸ§ª ksail cluster start
        run: |
          ./ksail cluster start

      - name: ðŸ§ª ksail cluster delete
        run: |
          ./ksail cluster delete

      - name: ðŸ§¹ Cleanup
        run: |
          if [ -d "k8s" ]; then rm -rf "k8s"; fi
          if [ -f "kind.yaml" ]; then rm "kind.yaml"; fi
          if [ -f "k3d.yaml" ]; then rm "k3d.yaml"; fi
          if [ -f "ksail.yaml" ]; then rm "ksail.yaml"; fi

  system-test-status:
    runs-on: ubuntu-latest
    needs: [system-test]
    if: always()
    steps:
      - name: Summarize matrix result
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "system-test result: $MATRIX_RESULT"
          case "$MATRIX_RESULT" in
            success|skipped)
              echo "All matrix runs succeeded or were skipped."
              exit 0
              ;;
            *)
              echo "At least one matrix run failed."
              exit 1
              ;;
          esac
        env:
          MATRIX_RESULT: ${{ needs.system-test.result }}
