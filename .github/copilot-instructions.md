# KSail Go - Kubernetes Cluster Management CLI

KSail is a Go-based CLI tool for managing local Kubernetes clusters and workloads declaratively. It supports multiple distributions (Kind, K3d) and reconciliation tools (Kubectl, Flux) to streamline local Kubernetes development.

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Working Effectively

### Bootstrap and Build
- **Install Go 1.24.6+**: Verify with `go version`
- **Download dependencies**: `go mod download` (completes in ~30 seconds)
- **Build the application**: `go build -o ksail .` -- takes 75 seconds initially, 7 seconds when cached. NEVER CANCEL. Set timeout to 180+ seconds.
- **Install golangci-lint v2**: `curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b ~/go/bin latest`

### Required Dependencies
- **Docker**: Container runtime - verify with `docker --version`
- **Kind**: Local Kubernetes clusters - verify with `kind version` 
- **kubectl**: Kubernetes CLI - verify with `kubectl version --client`
- **Go 1.24.6+**: Programming language runtime

### Testing and Validation
- **Run tests**: `go test -v ./...` -- takes 14 seconds. NEVER CANCEL. Set timeout to 60+ seconds.
- **Run linter**: `~/go/bin/golangci-lint run` -- takes 33 seconds. NEVER CANCEL. Set timeout to 120+ seconds.
  - **WARNING**: Linter currently reports 336 issues including depguard violations - this is expected
  - Focus on new issues you introduce, not existing ones

### Application Usage
- **Get help**: `./ksail --help`
- **Initialize project**: `./ksail init --name test-cluster` (creates ksail.yaml, kind.yaml, k8s/kustomization.yaml)
- **Provision cluster**: `./ksail up` -- takes 34 seconds for Kind cluster. NEVER CANCEL. Set timeout to 300+ seconds.
- **List clusters**: `./ksail list`
- **Destroy cluster**: `./ksail down`

## Validation Scenarios

### CRITICAL: Always test complete workflows after making changes
1. **Build Validation**: 
   - Run `go build -o ksail .` 
   - Verify `./ksail --help` shows usage
   
2. **Project Initialization**:
   - Create test directory: `mkdir -p /tmp/ksail-test && cd /tmp/ksail-test`
   - Run `./ksail init --name test-cluster`
   - Verify files created: `ksail.yaml`, `kind.yaml`, `k8s/kustomization.yaml`
   - **IMPORTANT**: Edit `ksail.yaml` to fix context name from `kind-ksail-default` to `kind-test-cluster`

3. **Cluster Lifecycle Test**:
   - Run `./ksail up` (provisions Kind cluster)
   - Run `./ksail list` (should show running cluster)
   - Run `./ksail down` (destroys cluster)
   - Run `./ksail list` (should show no clusters)

4. **Development Workflow**:
   - Run tests: `go test -v ./...`
   - Check build: `go build -o ksail .`
   - Basic functionality: `./ksail --help`

## Build and Timing Information

### NEVER CANCEL Commands - Exact Timeouts Required
- **`go build -o ksail .`**: 75 seconds initial build, 7 seconds cached -- SET TIMEOUT TO 180+ SECONDS
- **`go test -v ./...`**: 14 seconds measured -- SET TIMEOUT TO 60+ SECONDS  
- **`~/go/bin/golangci-lint run`**: 33 seconds measured -- SET TIMEOUT TO 120+ SECONDS
- **`./ksail up` (cluster creation)**: 21-34 seconds measured -- SET TIMEOUT TO 300+ SECONDS
- **`go mod download`**: 30 seconds measured -- SET TIMEOUT TO 120+ SECONDS

### Linting Expectations
- **Known Issues**: 336 linting issues exist (depguard, wsl, revive, etc.)
- **Focus**: Only address NEW issues you introduce
- **Config**: Uses `.golangci.yaml` with v2 format
- **Command**: `~/go/bin/golangci-lint run` (use full path, not system golangci-lint)

## Codebase Navigation

### Key Directories
- **`cmd/`**: CLI command implementations (init.go, up.go, down.go, etc.)
- **`pkg/apis/v1alpha1/cluster/`**: Core cluster API types and constructors
- **`pkg/provisioner/`**: Cluster provisioning logic (Kind, K3d)
- **`pkg/bootstrapper/`**: Reconciliation tool setup (Kubectl, Flux) 
- **`internal/validators/`**: Configuration validation logic
- **`internal/loader/`**: Configuration file loading
- **`pages/docs/`**: Jekyll-based documentation

### Important Files
- **`main.go`**: Application entry point
- **`go.mod`**: Go module dependencies
- **`.golangci.yaml`**: Linter configuration (v2 format)
- **`ksail.yaml`**: Generated cluster configuration
- **`kind.yaml`**: Generated Kind cluster config

### Command Structure
- **Root**: `cmd/root.go` - Main CLI setup
- **Init**: `cmd/init.go` - Project scaffolding  
- **Up**: `cmd/up.go` - Cluster provisioning
- **Down**: `cmd/down.go` - Cluster destruction
- **List**: `cmd/list.go` - Cluster listing

## Configuration Files

### Generated by `ksail init`
- **`ksail.yaml`**: Main KSail configuration (API version: ksail.dev/v1alpha1)
- **`kind.yaml`**: Kind cluster configuration (kindest/node:v1.33.1 image)
- **`k8s/kustomization.yaml`**: Kustomize entry point

### Context Name Validation
- **CRITICAL**: KSail validates that `spec.connection.context` matches expected pattern
- **Pattern**: `kind-{cluster-name}` for Kind clusters
- **Fix**: When using `--name test-cluster`, context should be `kind-test-cluster`

## Development Workflow

### Making Changes
1. **Always** run tests first: `go test -v ./...` 
2. **Always** build after changes: `go build -o ksail .`
3. **Always** test basic CLI: `./ksail --help`
4. **Always** test real scenario (init → up → down workflow)
5. **Always** run linter before committing: `~/go/bin/golangci-lint run`

### Testing New Features
1. Create isolated test directory in `/tmp/`
2. Test `ksail init` with various parameters
3. Verify generated configuration files
4. Test cluster provisioning if relevant
5. Clean up test clusters with `ksail down`

## Troubleshooting

### Common Issues
- **Build fails**: Check Go version (need 1.24.6+), run `go mod download`
- **Linter fails**: Install correct version with install script, use `~/go/bin/golangci-lint`
- **Context validation error**: Check ksail.yaml context name matches `kind-{cluster-name}`
- **Dependencies missing**: Verify Docker, Kind, kubectl are installed and accessible

### Known Limitations
- **Reconciliation tool**: "unsupported reconciliation tool ''" error at end of `ksail up` (known issue, cluster still works)
- **Depguard**: Many import violations exist (work around existing issues)
- **Test coverage**: Minimal - only one test file in `cmd/inputs/helpers_test.go`

## CI/CD Information

### GitHub Actions
- **CI**: Uses `avamsi/go-nogo/.github/workflows/ci.yml@main`
- **CD**: Currently no-op (`noop` job)
- **Location**: `.github/workflows/` and `workflows/` directories

### Future Integration
- Project follows GitHub Flow with PR-based development
- KSail can be used in CI/CD for E2E testing (see `pages/docs/use-cases/e2e-testing-in-cicd.md`)

---

**Last Updated**: Based on repository state with Go 1.24.6, Kind v0.29.0, Docker 28.0.4